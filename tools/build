#!/usr/bin/env bash
set -e

opt_pkg="packages.x86_64"

work_dir="work_dir"
tmp_dir="${work_dir}/tmp"
root_dir="${work_dir}/rootfs"
esp_dir="${work_dir}/esp"
iso_dir="${work_dir}/iso"

prepare_rootfs() {
    mkdir -p "${root_dir}"
    cp -af --no-preserve=ownership,mode -T airootfs "${root_dir}"
    local -a package_lst
    mapfile -t pkg_lst < <(sed '/^[[:blank:]]*#.*/d;s/#.*//;/^[[:blank:]]*$/d' "${opt_pkg}")

    pacstrap -c -G -M "${root_dir}" "${pkg_lst[@]}"
}

prepare_esp() {
    mkdir -p "${esp_dir}/EFI/BOOT"
    local grubmodules=(all_video at_keyboard boot btrfs cat chain configfile echo efifwsetup efinet exfat ext2 f2fs fat font \
                 gfxmenu gfxterm gzio halt hfsplus iso9660 jpeg keylayouts linux loadenv loopback lsefi lsefimmap \
                 minicmd normal ntfs ntfscomp part_apple part_gpt part_msdos png read reboot regexp search \
                 search_fs_file search_fs_uuid search_label serial sleep tpm udf usb usbserial_common usbserial_ftdi \
                 usbserial_pl2303 usbserial_usbdebug video xfs zstd)
    grub-mkstandalone -O x86_64-efi \
        --modules="${grubmodules[*]}" \
        -o "${esp_dir}/EFI/BOOT/BOOTx64.EFI" \
        grub/grub.cfg
}

# https://wiki.syslinux.org/wiki/index.php?title=Isohybrid
make_iso() {
    mkdir -p "${tmp_dir}"
    local efibootimg="${tmp_dir}/efiboot.img"
    rm -rf "${efibootimg}"
    mkfs.fat -C -F 32 "${efibootimg}" "$((256*1024))"
    mmd -i "${efibootimg}" ::/EFI ::/EFI/BOOT
    mcopy -i "${efibootimg}" "${esp_dir}/EFI/BOOT/BOOTx64.EFI" ::/EFI/BOOT/BOOTx64.EFI

    mkdir -p "${iso_dir}/boot/grub"
    cp "${efibootimg}" "${iso_dir}/boot/grub/"
    xorriso \
        -no_rc -as mkisofs \
        -iso-level 3 -full-iso9660-filenames \
        -joliet -joliet-long -rational-rock \
        -isohybrid-mbr "${iso_dir}/boot/syslinux/isohdpfx.bin" \
        -c boot/syslinux/boot.cat \
        -b boot/syslinux/isolinux.bin \
        -no-emul-boot -boot-load-size 4 -boot-info-table \
        -eltorito-alt-boot \
        -e boot/grub/efiboot.img \
        -no-emul-boot \
        -isohybrid-gpt-basdat \
        -o demo.iso \
        "${iso_dir}"
}

main() {
    # prepare_rootfs
    prepare_esp
    make_iso
}

main "$@"

